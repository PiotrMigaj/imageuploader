<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SELECTION MANAGER | NIEBIESKIE APARATY</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Italiana&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
          --primary-color: #ffffff;
          --secondary-color: #121212;
          --accent-color: #f5f5f5;
          --text-light: #989898;
          --success-color: #198754;
          --warning-color: #ffc107;
        }

        body {
          font-family: 'Montserrat', sans-serif;
          background-color: var(--primary-color);
          color: var(--secondary-color);
          min-height: 100vh;
        }

        .navbar-custom {
          padding: 1.2rem 2rem;
          border-bottom: 1px solid #e6e6e6;
          background-color: var(--primary-color);
        }

        .navbar-brand {
          font-family: 'Italiana', serif;
          font-size: 1.6rem;
          letter-spacing: 1.5px;
        }

        .logout-btn {
          background: none;
          border: none;
          font-size: 1rem;
          color: var(--secondary-color);
          display: flex;
          align-items: center;
          gap: 0.5rem;
          transition: color 0.2s;
        }

        .logout-btn:hover {
          color: #444;
        }

        .selection-table {
          border-radius: 8px;
          overflow: hidden;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .table-hover tbody tr:hover {
          background-color: var(--accent-color);
        }

        .radio-container {
          display: flex;
          justify-content: center;
          align-items: center;
        }

        .form-check-input:checked {
          background-color: var(--secondary-color);
          border-color: var(--secondary-color);
        }

        .directory-picker {
          border: 2px dashed #dee2e6;
          border-radius: 8px;
          padding: 2rem;
          text-align: center;
          transition: all 0.3s ease;
          cursor: pointer;
        }

        .directory-picker:hover {
          border-color: var(--secondary-color);
          background-color: var(--accent-color);
        }

        .directory-picker.active {
          border-color: var(--success-color);
          background-color: rgba(25, 135, 84, 0.1);
        }

        .submit-btn {
          background-color: var(--secondary-color);
          border-color: var(--secondary-color);
          padding: 0.75rem 2rem;
          font-weight: 500;
          transition: all 0.3s ease;
        }

        .submit-btn:hover:not(:disabled) {
          background-color: #000;
          border-color: #000;
          transform: translateY(-1px);
        }

        .submit-btn:disabled {
          background-color: var(--text-light);
          border-color: var(--text-light);
        }

        .selection-status {
          font-size: 0.875rem;
          padding: 0.25rem 0.5rem;
          border-radius: 4px;
          font-weight: 500;
        }

        .status-blocked {
          background-color: rgba(220, 53, 69, 0.1);
          color: #dc3545;
        }
    </style>
</head>
<body id="app">
<nav class="navbar navbar-custom d-flex justify-content-between align-items-center">
    <span class="navbar-brand">NIEBIESKIE APARATY â€“ SELECTION MANAGER</span>
    <button class="logout-btn" @click="logout">
        <i class="bi bi-box-arrow-right"></i>
        Logout
    </button>
</nav>

<div class="container py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="h4 mb-2">Blocked Selections</h2>
            <p class="text-muted">Select a blocked selection and choose a directory to process.</p>
        </div>
    </div>

    <!-- Selections Table -->
    <div class="row mb-4">
        <div class="col">
            <div class="card selection-table">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" class="text-center" style="width: 80px;">Select</th>
                                    <th scope="col">Selection ID</th>
                                    <th scope="col">Event Title</th>
                                    <th scope="col">Event ID</th>
                                    <th scope="col">Username</th>
                                    <th scope="col" class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="selections.length === 0">
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        No blocked selections found
                                    </td>
                                </tr>
                                <tr v-for="selection in selections" :key="selection.selectionId" 
                                    :class="{ 'table-active': selectedSelectionId === selection.selectionId }"
                                    @click="selectSelection(selection.selectionId)">
                                    <td class="radio-container">
                                        <input 
                                            class="form-check-input" 
                                            type="radio" 
                                            :name="'selection-radio'"
                                            :value="selection.selectionId"
                                            v-model="selectedSelectionId"
                                            @change="selectSelection(selection.selectionId)">
                                    </td>
                                    <td class="fw-medium">\{{ selection.selectionId }}</td>
                                    <td>\{{ selection.eventTitle || 'N/A' }}</td>
                                    <td><code>\{{ selection.eventId }}</code></td>
                                    <td>\{{ selection.username }}</td>
                                    <td class="text-center">
                                        <span class="selection-status status-blocked">
                                            <i class="bi bi-lock-fill me-1"></i>Blocked
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Directory Path Section -->
    <div class="row mb-4">
        <div class="col">
            <h5 class="mb-3">Directory Path</h5>
            
            <!-- Manual Directory Path Input -->
            <div class="mb-3">
                <label for="directoryPath" class="form-label">Full Directory Path</label>
                <input 
                    type="text" 
                    id="directoryPath"
                    class="form-control" 
                    v-model="manualDirectoryPath"
                    @input="updateDirectoryFromManualInput"
                    placeholder="Paste full directory path (e.g., /Users/username/Documents/photos or C:\Users\username\Documents\photos)"
                    style="font-family: 'Courier New', monospace;">
                <div class="form-text">
                    <i class="bi bi-info-circle me-1"></i>
                    Paste the complete path to the directory you want to process
                </div>
            </div>

            <!-- Directory Summary -->
            <div class="card bg-light" v-if="manualDirectoryPath.trim()">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col">
                            <i class="bi bi-folder-fill text-primary me-2"></i>
                            <strong>Directory:</strong> \{{ extractDirectoryName(manualDirectoryPath) }}
                        </div>
                        <div class="col-auto">
                            <small class="text-muted">Path: \{{ manualDirectoryPath }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Section -->
    <div class="row mb-4">
        <div class="col text-end">
            <button 
                class="btn btn-dark submit-btn"
                :disabled="!selectedSelectionId || !manualDirectoryPath.trim() || isSubmitting"
                @click="submitSelection">
                <span v-if="isSubmitting">
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    Processing...
                </span>
                <span v-else>
                    <i class="bi bi-check-circle me-2"></i>
                    Process Selection
                </span>
            </button>
        </div>
    </div>

    <!-- Status Messages -->
    <div class="row" v-if="message">
        <div class="col">
            <div class="alert" :class="success ? 'alert-success' : 'alert-danger'" role="alert">
                <i :class="success ? 'bi bi-check-circle-fill' : 'bi bi-exclamation-triangle-fill'" class="me-2"></i>
\{{ message }}
            </div>
        </div>
    </div>

    <!-- Selection Summary -->
    <div class="row" v-if="selectedSelectionId">
        <div class="col">
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-info-circle me-2"></i>
                        Selection Summary
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Selected:</strong> \{{ getSelectedSelection()?.selectionId }}
                        </div>
                        <div class="col-md-6">
                            <strong>Directory:</strong> \{{ extractDirectoryName(manualDirectoryPath) || 'Not entered' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;

    createApp({
      setup() {
        // Initialize selections from server data
        const selections = ref([{#for selection in selections}
            {
                selectionId: '{selection.selectionId}',
                blocked: {selection.blocked},
                eventId: '{selection.eventId}',
                eventTitle: '{selection.eventTitle}',
                username: '{selection.username}'
            }{#if selection_hasNext},{/if}
        {/for}]);

        const selectedSelectionId = ref('');
        const selectedDirectory = ref(null);
        const directoryInput = ref(null);
        const manualDirectoryPath = ref('');
        const message = ref('');
        const success = ref(false);
        const isSubmitting = ref(false);

        const selectSelection = (selectionId) => {
            selectedSelectionId.value = selectionId;
            message.value = '';
        };

        const getSelectedSelection = () => {
            return selections.value.find(s => s.selectionId === selectedSelectionId.value);
        };

        const triggerDirectoryPicker = () => {
            directoryInput.value.click();
        };

        const extractDirectoryName = (path) => {
            if (!path) return '';
            const cleanPath = path.trim().replace(/\\/g, '/');
            const parts = cleanPath.split('/').filter(part => part.length > 0);
            return parts[parts.length - 1] || '';
        };

        const updateDirectoryFromManualInput = () => {
            message.value = '';
        };

        const submitSelection = async () => {
            if (!selectedSelectionId.value) {
                message.value = 'Please select a selection.';
                success.value = false;
                return;
            }

            if (!manualDirectoryPath.value.trim()) {
                message.value = 'Please enter a directory path.';
                success.value = false;
                return;
            }

            isSubmitting.value = true;
            message.value = '';

            try {
                const fullPath = manualDirectoryPath.value.trim();
                const directoryName = extractDirectoryName(fullPath);
                
                const requestBody = {
                    selectionId: selectedSelectionId.value,
                    directoryPath: fullPath,
                    directoryName: directoryName
                };

                const response = await fetch('/api/selections/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }

                const result = await response.json();
                if (result.movedFiles && result.movedFiles.length > 0) {
                    const filesList = result.movedFiles.join(', ');
                    message.value = `$\{result.message}. Moved $\{result.count} files: $\{filesList}`;
                } else {
                    message.value = result.message || 'Selection processed successfully!';
                }
                success.value = true;
                
                // Reset form
                selectedSelectionId.value = '';
                manualDirectoryPath.value = '';

            } catch (error) {
                console.error('Error processing selection:', error);
                message.value = 'Failed to process selection. Please try again.';
                success.value = false;
            } finally {
                isSubmitting.value = false;
            }
        };

        const logout = async () => {
            try {
                await fetch('/logout', { method: 'POST', credentials: 'same-origin' });
                document.cookie = "quarkus-credential=; Max-Age=0; path=/";
                document.cookie = "quarkus-redirect-location=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                window.location.href = "/login?logout=true";
            } catch (error) {
                alert("Logout failed. Try again.");
            }
        };

        return {
            selections,
            selectedSelectionId,
            selectedDirectory,
            directoryInput,
            manualDirectoryPath,
            message,
            success,
            isSubmitting,
            selectSelection,
            getSelectedSelection,
            extractDirectoryName,
            updateDirectoryFromManualInput,
            submitSelection,
            logout
        };
      }
    }).mount('#app');
</script>
</body>
</html>